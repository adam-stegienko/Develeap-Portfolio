name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  docker-build:

    runs-on: ubuntu-22.04

    steps:  
    - uses: actions/checkout@v3
    - name: Env file creation
      run: |
        cat << EOF > .env
        APP_VERSION: latest
        DB_VERSION: 2022-latest
        DB_PORT_IN: 1433
        DB_PORT_OUT: 1433
        ACCEPT_EULA: Y
        MSSQL_SA_USER: ${{ secrets.MSSQL_SA_USER }}
        MSSQL_SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
        MSSQL_PID: Developer
        DATA_VOLUME: /var/opt/mssql
        MSSQL_DB: ${{ secrets.MSSQL_DB }}
        MSSQL_USER: ${{ secrets.MSSSQL_USER }}
        MSSQL_PASSWORD: ${{ secrets.MSSQL_PASSWORD }}
        MSSQL_SERVER: mssql_server
        DRIVER: FreeTDS
        PROTOCOL: mssql+pyodbc
        OPTIONS: 'TDS_Version=8.0'  
        EOF
    
    - name: Docker image build
      run: |
        # Build the image
        echo "\n${bold}---------------------------------------- BUILDING APP IMAGE --------------------------------------${normal}\n"
        docker build -t digital_planner:latest .

    - name: Set-up recreation
      run: |
        # Reinstate docker compose topology
        echo "\n${bold}---------------------------------------- RECREATING SET-UP ---------------------------------------${normal}\n"
        docker compose down
        docker compose up --detach --remove-orphans
        sleep 3
        # Check start-up logs
        echo "\n${bold}----------------------------------------- DATABASE LOGS ------------------------------------------${normal}\n"
        docker logs mssql_server
        sleep 2
        echo "\n${bold}---------------------------------------- APPLICATION LOGS ----------------------------------------${normal}\n"
        docker logs digital_planner
        sleep 2
        echo "\n${bold}--------------------------------------- REVERSE PROXY LOGS ---------------------------------------${normal}\n"
        docker logs reverse_nginx
        sleep 2

    - name: Unit testing
      run: |
        # Perform unit tests
        echo "\n${bold}--------------------------------------- RUNNING UNIT TESTS ---------------------------------------${normal}\n"
        command ./unit_tests.sh
        
    - name: Env file deletion
      run: |
        rm .env
